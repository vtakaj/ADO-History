# US-001-INF-003: 設定管理と環境変数処理実装

## Task Overview
Azure DevOps接続情報、認証情報、動作設定を環境変数で管理する機能を実装する。

## Acceptance Criteria
- [x] 環境変数による設定管理機能
- [x] Personal Access Token (PAT) の安全な管理
- [x] 組織名・プロジェクト名の設定
- [x] デフォルト値の設定
- [x] 設定値検証機能
- [x] 設定情報の表示機能（PAT除く）
- [x] 設定ファイル（.env）のサポート

## Technical Requirements
- 環境変数の読み込みと検証
- PAT の機密性保持（ログ出力での隠匿）
- 設定値のデフォルト値設定
- .env ファイルからの設定読み込み
- 設定値の型チェック

## Implementation Details
```bash
# 環境変数定義
AZURE_DEVOPS_PAT="${AZURE_DEVOPS_PAT:-}"
AZURE_DEVOPS_ORG="${AZURE_DEVOPS_ORG:-}"
AZURE_DEVOPS_PROJECT="${AZURE_DEVOPS_PROJECT:-}"
API_VERSION="${API_VERSION:-7.2}"
LOG_LEVEL="${LOG_LEVEL:-INFO}"
RETRY_COUNT="${RETRY_COUNT:-3}"
RETRY_DELAY="${RETRY_DELAY:-1}"

# .env ファイル読み込み
load_env_file() {
    local env_file=".env"
    
    if [[ -f "$env_file" ]]; then
        # セキュリティ: .envファイルの権限確認
        local perms=$(stat -c %a "$env_file" 2>/dev/null || stat -f %A "$env_file" 2>/dev/null)
        if [[ "$perms" != "600" ]]; then
            log_warn ".envファイルの権限が安全ではありません: $perms (推奨: 600)"
        fi
        
        # コメント行と空行を除外して読み込み
        set -a
        source <(grep -v '^#' "$env_file" | grep -v '^$')
        set +a
        
        log_info ".envファイルを読み込み: $env_file"
    fi
}

# 設定値検証
validate_config() {
    local errors=0
    
    # PAT 検証
    if [[ -z "$AZURE_DEVOPS_PAT" ]]; then
        log_error "AZURE_DEVOPS_PAT が設定されていません"
        ((errors++))
    elif [[ ${#AZURE_DEVOPS_PAT} -lt 52 ]]; then
        log_error "AZURE_DEVOPS_PAT の形式が正しくありません（長さ不足）"
        ((errors++))
    fi
    
    # 組織名検証
    if [[ -z "$AZURE_DEVOPS_ORG" ]]; then
        log_error "AZURE_DEVOPS_ORG が設定されていません"
        ((errors++))
    elif [[ ! "$AZURE_DEVOPS_ORG" =~ ^[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]$ ]]; then
        log_error "AZURE_DEVOPS_ORG の形式が正しくありません"
        ((errors++))
    fi
    
    # APIバージョン検証
    if [[ ! "$API_VERSION" =~ ^[0-9]+\.[0-9]+$ ]]; then
        log_error "API_VERSION の形式が正しくありません: $API_VERSION"
        ((errors++))
    fi
    
    # リトライ設定検証
    if [[ ! "$RETRY_COUNT" =~ ^[0-9]+$ ]] || [[ "$RETRY_COUNT" -lt 0 ]] || [[ "$RETRY_COUNT" -gt 10 ]]; then
        log_error "RETRY_COUNT は0-10の範囲で設定してください: $RETRY_COUNT"
        ((errors++))
    fi
    
    return $errors
}
```

## Environment Variables
```bash
# 必須設定
AZURE_DEVOPS_PAT=""              # Personal Access Token
AZURE_DEVOPS_ORG=""              # 組織名
AZURE_DEVOPS_PROJECT=""          # プロジェクト名（実行時指定も可）

# オプション設定
API_VERSION="7.2"                # Azure DevOps API バージョン
LOG_LEVEL="INFO"                 # ログレベル (ERROR|WARN|INFO)
RETRY_COUNT="3"                  # API呼び出しリトライ回数
RETRY_DELAY="1"                  # リトライ間隔（秒）
REQUEST_TIMEOUT="30"             # APIリクエストタイムアウト（秒）
BATCH_SIZE="50"                  # バッチ処理サイズ
```

## .env File Template
```bash
# .env ファイル生成
generate_env_template() {
    cat > .env.template << 'EOF'
# Azure DevOps 接続設定
AZURE_DEVOPS_PAT=your_personal_access_token_here
AZURE_DEVOPS_ORG=your_organization_name
AZURE_DEVOPS_PROJECT=your_default_project_name

# API設定
API_VERSION=7.2
LOG_LEVEL=INFO

# リトライ設定
RETRY_COUNT=3
RETRY_DELAY=1
REQUEST_TIMEOUT=30

# バッチ処理設定
BATCH_SIZE=50
EOF
    
    chmod 600 .env.template
    log_info ".env.template を生成しました"
    log_info ".env.template を .env にコピーして設定値を入力してください"
}
```

## Configuration Display
```bash
# 設定情報表示（PAT除く）
show_config() {
    cat << EOF
=== Azure DevOps Tracker 設定情報 ===
組織名: ${AZURE_DEVOPS_ORG:-"(未設定)"}
デフォルトプロジェクト: ${AZURE_DEVOPS_PROJECT:-"(未設定)"}
APIバージョン: $API_VERSION
ログレベル: $LOG_LEVEL
リトライ回数: $RETRY_COUNT
リトライ間隔: ${RETRY_DELAY}秒
リクエストタイムアウト: ${REQUEST_TIMEOUT}秒
バッチサイズ: $BATCH_SIZE
PAT設定: $(if [[ -n "$AZURE_DEVOPS_PAT" ]]; then echo "設定済み"; else echo "未設定"; fi)
EOF
}

# PAT のマスク表示
mask_pat() {
    local pat="$1"
    if [[ -n "$pat" && ${#pat} -gt 8 ]]; then
        echo "${pat:0:4}****${pat: -4}"
    else
        echo "****"
    fi
}
```

## Configuration Commands
```bash
# 設定確認コマンド
cmd_config() {
    case "${1:-show}" in
        show)
            show_config
            ;;
        validate)
            if validate_config; then
                echo "設定は正常です"
            else
                echo "設定にエラーがあります" >&2
                exit 2
            fi
            ;;
        template)
            generate_env_template
            ;;
        *)
            echo "Usage: $SCRIPT_NAME config [show|validate|template]" >&2
            exit 1
            ;;
    esac
}
```

## Definition of Done
- [x] 環境変数から設定値が正しく読み込まれる
- [x] PATが適切にマスクされてログ出力される
- [x] 設定値検証でエラーが適切に検出される
- [x] .envファイルサポートが動作する
- [x] 設定テンプレート生成機能が動作する

## Dependencies
- US-001-INF-001 (基本構造)

## Estimated Effort
2-3 hours

## Testing Strategy
- 環境変数未設定時のエラーテスト
- 無効な設定値での検証テスト
- .envファイル権限のテスト
- PATマスキング機能のテスト
- 設定表示機能のテスト