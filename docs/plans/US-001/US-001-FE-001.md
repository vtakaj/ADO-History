# US-001-FE-001: コンソール出力フォーマット実装

## Task Overview
取得したチケット情報とステータス履歴をコンソールに見やすく表示する機能を実装する。

## Acceptance Criteria
- [ ] チケット一覧のテーブル形式表示
- [ ] ステータス履歴の時系列表示
- [ ] 進捗インジケーターの表示
- [ ] エラーメッセージの適切な表示
- [ ] カラー出力のサポート（オプション）
- [ ] 出力フォーマットの設定可能
- [ ] 日本語文字幅の適切な処理

## Technical Requirements
- printf/echo による整形出力
- ANSI カラーコードの使用
- 文字幅計算（全角/半角対応）
- テーブル列幅の自動調整
- ページング機能（lessコマンド連携）

## Implementation Details
```bash
# カラー設定
if [[ -t 1 ]] && [[ "${NO_COLOR:-}" != "1" ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    BOLD='\033[1m'
    RESET='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' BOLD='' RESET=''
fi

# チケット一覧表示
display_workitems() {
    local format="${1:-table}"
    local workitems_file="$DATA_DIR/workitems.json"
    
    if [[ ! -f "$workitems_file" ]]; then
        echo "${RED}エラー: チケットデータが見つかりません${RESET}" >&2
        return 1
    fi
    
    case "$format" in
        table)
            display_workitems_table "$workitems_file"
            ;;
        list)
            display_workitems_list "$workitems_file"
            ;;
        summary)
            display_workitems_summary "$workitems_file"
            ;;
    esac
}

# テーブル形式表示
display_workitems_table() {
    local workitems_file="$1"
    
    printf "${BOLD}%-8s %-50s %-20s %-15s${RESET}\n" \
        "ID" "タイトル" "担当者" "ステータス"
    printf "%-8s %-50s %-20s %-15s\n" \
        "--------" "$(printf '%.50s' "$(printf '%*s' 50 '' | tr ' ' '-')")" \
        "$(printf '%.20s' "$(printf '%*s' 20 '' | tr ' ' '-')")" \
        "$(printf '%.15s' "$(printf '%*s' 15 '' | tr ' ' '-')")"
    
    jq -r '.workitems[] | [.id, .title, .assignedTo, .state] | @tsv' "$workitems_file" | \
    while IFS=$'\t' read -r id title assignedTo state; do
        # 文字列切り詰め
        title=$(printf '%.50s' "$title")
        assignedTo=$(printf '%.20s' "$assignedTo")
        
        # ステータス別カラー
        case "$state" in
            "New"|"Proposed") color="$BLUE" ;;
            "Active"|"In Progress") color="$YELLOW" ;;
            "Resolved"|"Completed") color="$GREEN" ;;
            "Closed"|"Done") color="$GREEN" ;;
            *) color="$RESET" ;;
        esac
        
        printf "%-8s %-50s %-20s ${color}%-15s${RESET}\n" \
            "$id" "$title" "$assignedTo" "$state"
    done
}
```

## Progress Indicator
```bash
# 進捗表示
show_progress() {
    local current="$1"
    local total="$2"
    local message="$3"
    
    local percentage=$((current * 100 / total))
    local bar_length=50
    local filled_length=$((percentage * bar_length / 100))
    
    # プログレスバー作成
    local bar=""
    for ((i=0; i<filled_length; i++)); do bar+="█"; done
    for ((i=filled_length; i<bar_length; i++)); do bar+="░"; done
    
    printf "\r${BLUE}[%s] %3d%% (%d/%d) %s${RESET}" \
        "$bar" "$percentage" "$current" "$total" "$message"
    
    if [[ "$current" -eq "$total" ]]; then
        echo  # 改行
    fi
}

# スピナー表示
show_spinner() {
    local pid="$1"
    local message="$2"
    local spinner="⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"
    local i=0
    
    while kill -0 "$pid" 2>/dev/null; do
        printf "\r${YELLOW}%s ${message}${RESET}" "${spinner:i++%${#spinner}:1}"
        sleep 0.1
    done
    printf "\r%*s\r" $((${#message} + 10)) ""  # クリア
}
```

## Status History Display
```bash
# ステータス履歴表示
display_status_history() {
    local workitem_id="$1"
    local history_file="$DATA_DIR/status_history.json"
    
    if [[ ! -f "$history_file" ]]; then
        echo "${RED}エラー: ステータス履歴データが見つかりません${RESET}" >&2
        return 1
    fi
    
    echo "${BOLD}=== チケット #${workitem_id} ステータス履歴 ===${RESET}"
    echo
    
    jq -r --arg id "$workitem_id" \
        '.status_history[] | select(.workitemId == ($id | tonumber)) | 
         [.changeDate, .changedBy, .previousStatus, .newStatus] | @tsv' \
        "$history_file" | \
    while IFS=$'\t' read -r changeDate changedBy previousStatus newStatus; do
        # 日時フォーマット
        local formatted_date
        formatted_date=$(date -d "$changeDate" '+%Y-%m-%d %H:%M' 2>/dev/null || \
                        date -j -f "%Y-%m-%dT%H:%M:%S" "${changeDate%+*}" '+%Y-%m-%d %H:%M' 2>/dev/null || \
                        echo "$changeDate")
        
        printf "${BLUE}%s${RESET} ${BOLD}%s${RESET}\n" "$formatted_date" "$changedBy"
        printf "  %s → ${GREEN}%s${RESET}\n" "$previousStatus" "$newStatus"
        echo
    done
}
```

## Summary Statistics
```bash
# サマリー統計表示
display_workitems_summary() {
    local workitems_file="$1"
    
    echo "${BOLD}=== チケット統計 ===${RESET}"
    echo
    
    # 総数
    local total_count
    total_count=$(jq '.workitems | length' "$workitems_file")
    echo "総チケット数: ${BOLD}$total_count${RESET}"
    echo
    
    # ステータス別統計
    echo "${BOLD}ステータス別内訳:${RESET}"
    jq -r '.workitems | group_by(.state) | .[] | "\(.[0].state): \(length)"' \
        "$workitems_file" | \
    while IFS=': ' read -r status count; do
        case "$status" in
            "New"|"Proposed") color="$BLUE" ;;
            "Active"|"In Progress") color="$YELLOW" ;;
            "Resolved"|"Completed"|"Closed"|"Done") color="$GREEN" ;;
            *) color="$RESET" ;;
        esac
        printf "  ${color}%-15s: %3d${RESET}\n" "$status" "$count"
    done
    echo
    
    # 担当者別統計
    echo "${BOLD}担当者別内訳 (上位5名):${RESET}"
    jq -r '.workitems | group_by(.assignedTo) | 
           sort_by(length) | reverse | 
           .[0:5] | .[] | "\(.[0].assignedTo): \(length)"' \
        "$workitems_file" | \
    while IFS=': ' read -r assignee count; do
        printf "  %-30s: %3d\n" "$assignee" "$count"
    done
}
```

## Output Control
```bash
# 出力制御オプション
OUTPUT_FORMAT="${OUTPUT_FORMAT:-table}"  # table|list|summary
PAGER="${PAGER:-less -R}"               # ページャー設定
NO_COLOR="${NO_COLOR:-0}"               # カラー無効化

# ページング対応出力
paginated_output() {
    local content="$1"
    
    if [[ -t 1 ]] && command -v "$PAGER" >/dev/null; then
        echo "$content" | $PAGER
    else
        echo "$content"
    fi
}
```

## Definition of Done
- チケット一覧がテーブル形式で見やすく表示される
- ステータス履歴が時系列で表示される
- 進捗表示とスピナーが動作する
- カラー出力が適切に動作する
- 統計情報が正確に表示される

## Dependencies
- US-001-INF-002 (データ管理)
- US-001-BE-002 (チケット一覧)
- US-001-BE-003 (履歴取得)

## Estimated Effort
2-3 hours

## Testing Strategy
- 大量データでの表示確認
- カラー出力の有効/無効テスト
- 異なる端末サイズでの表示確認
- 日本語文字幅の表示確認
- ページング機能のテスト