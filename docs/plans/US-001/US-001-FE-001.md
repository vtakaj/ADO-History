# US-001-FE-001: マークダウン作業記録テーブル出力実装

## Task Overview
取得したチケット情報とステータス履歴から、作業記録用のマークダウンテーブルを生成する機能を実装する。

## Acceptance Criteria
- [x] マークダウン形式のテーブル出力
- [x] 日付範囲指定による月次テーブル生成
- [x] 担当者別の動的列生成
- [x] チケットステータス変更履歴による作業内容自動記録
- [x] 手入力用の作業時間列（h:mm形式）
- [x] 月間作業時間合計表示（フッター）
- [x] Blockedステータス考慮の表示制御
- [x] 月単位の対応チケット番号・タイトルリスト出力

## Technical Requirements
- マークダウンテーブル形式での出力
- チケットのステータス変更履歴を解析
- Doing → Done期間の作業内容表示
- Blockedステータス時の表示制御
- ファイル出力（.mdファイル）
- 月単位のチケットリスト生成

## Output Format Specification

### テーブル構造
```markdown
| 日付 | 曜日 | 担当者1 | 作業内容 | 担当者2 | 作業内容 | ... |
|------|------|---------|----------|---------|----------|-----|
| 2025/01/01 | 水 |  |  | 12345 |  | ... |
| 2025/01/02 | 木 |  | 12346 |  |  | ... |
| ... | ... | ... | ... | ... | ... | ... |
| **合計** |  | **120:30** |  | **85:45** |  | ... |

## 対応チケット一覧 (2025年1月)

- **12345**: Implement user authentication feature
- **12346**: Fix login validation bug  
- **12347**: Update API documentation
- **12348**: Refactor database connection pool
```

### 列構成
1. **日付**: yyyy/mm/dd形式
2. **曜日**: 日本語表記（月、火、水、木、金、土、日）
3. **担当者名**: 動的に検出された担当者名
4. **作業内容**: 手入力用（空白）、チケットが稼働中の場合はチケット番号を表示
5. 担当者数に応じて担当者名・作業内容の組み合わせを繰り返し

### 作業内容表示ルール
- **Doing状態**: チケットがDoingになった日からチケット番号を表示
- **Done状態**: チケットがDoneになった日まで継続表示
- **Blocked状態**: Blockedになった翌日から表示停止
- **Blocked解除**: BlockedからDoing/Doneに変わった日に表示再開

### チケットリスト出力
- 月単位で全員が対応したチケットの一覧を出力
- チケット番号とタイトルを含む
- マークダウンの箇条書き形式
- 作業記録テーブルの下部に配置

## Implementation Details

### 基本関数
```bash
# 月次作業記録テーブル生成
generate_monthly_work_table() {
    local year_month="$1"      # YYYY-MM形式
    local output_file="$2"     # 出力ファイルパス
    
    # ステータス履歴から担当者を抽出
    local assignees=$(extract_assignees_from_history "$year_month")
    
    # テーブルヘッダー生成
    generate_table_header "$assignees" > "$output_file"
    
    # 月の各日についてテーブル行を生成
    local start_date="${year_month}-01"
    local end_date=$(get_last_day_of_month "$year_month")
    
    local current_date="$start_date"
    while [[ "$current_date" <= "$end_date" ]]; do
        generate_table_row "$current_date" "$assignees" >> "$output_file"
        current_date=$(date -d "$current_date + 1 day" '+%Y-%m-%d')
    done
    
    # フッター（月間合計）生成
    generate_table_footer "$assignees" >> "$output_file"
    
    # チケットリスト生成
    generate_ticket_list "$year_month" >> "$output_file"
}

# テーブルヘッダー生成
generate_table_header() {
    local assignees=("$@")
    
    echo -n "| 日付 | 曜日 |"
    for assignee in "${assignees[@]}"; do
        echo -n " $assignee | 作業内容 |"
    done
    echo
    
    echo -n "|------|------|"
    for assignee in "${assignees[@]}"; do
        echo -n "---------|----------|"
    done
    echo
}

# テーブル行生成
generate_table_row() {
    local date="$1"
    shift
    local assignees=("$@")
    
    local formatted_date=$(date -d "$date" '+%Y/%m/%d')
    local day_of_week=$(date -d "$date" '+%u')
    local japanese_dow=$(get_japanese_day_of_week "$day_of_week")
    
    echo -n "| $formatted_date | $japanese_dow |"
    
    for assignee in "${assignees[@]}"; do
        local work_content=""
        local active_tickets=$(get_active_tickets_for_assignee_on_date "$assignee" "$date")
        
        if [[ -n "$active_tickets" ]]; then
            work_content="$active_tickets"
        fi
        
        echo -n " | $work_content |"
    done
    echo
}
```

### ステータス履歴解析
```bash
# 指定日の担当者の稼働チケット取得
get_active_tickets_for_assignee_on_date() {
    local assignee="$1"
    local date="$2"
    
    # ステータス履歴から以下を判定：
    # 1. 該当日にDoingまたはDone状態のチケット
    # 2. Blockedでない、またはBlocked解除後のチケット
    # 3. 担当者は実際の assignedTo フィールドから取得
    
    jq -r --arg assignee "$assignee" --arg target_date "$date" '
        .status_history | group_by(.workitemId) |
        .[] |
        select(.[0].workitemId) as $ticket_group |
        map(select(.changeDate <= ($target_date + "T23:59:59+09:00"))) | sort_by(.changeDate) |
        if length > 0 then
            .[-1] |
            if (.assignedTo == $assignee and (.newStatus == "Doing" or .newStatus == "Code Review" or .newStatus == "Active")) then
                .workitemId
            elif (.assignedTo == $assignee and .newStatus == "Done") then
                if (.changeDate[0:10] == $target_date) then
                    .workitemId
                else
                    empty  
                end
            else
                empty
            end
        else
            empty
        end
    ' "$DATA_DIR/status_history.json" | tr '\n' ' '
}

# Blockedチケットの判定
is_ticket_blocked_on_date() {
    local workitem_id="$1"
    local date="$2"
    
    # 指定日以前の最新ステータスを取得
    local latest_status=$(jq -r --arg id "$workitem_id" --arg date "$date" '
        .status_history[] |
        select(.workitemId == ($id | tonumber)) |
        select(.changeDate <= $date) |
        sort_by(.changeDate) |
        .[-1].newStatus
    ' "$DATA_DIR/status_history.json")
    
    [[ "$latest_status" == "Blocked" ]]
}

# 月単位のチケットリスト生成
generate_ticket_list() {
    local year_month="$1"
    
    echo
    echo "## 対応チケット一覧 (${year_month//-/年}月)"
    echo
    
    # 指定月にステータス変更があったチケットを取得
    local tickets=$(jq -r --arg year_month "$year_month" '
        .status_history[] |
        select(.changeDate | startswith($year_month)) |
        .workitemId
    ' "$DATA_DIR/status_history.json" | sort -u)
    
    # 各チケットの情報を取得して表示
    for ticket_id in $tickets; do
        local ticket_info=$(jq -r --arg id "$ticket_id" '
            .workitems[] |
            select(.id == ($id | tonumber)) |
            "- **\(.id)**: \(.title)"
        ' "$DATA_DIR/workitems.json")
        
        if [[ -n "$ticket_info" ]]; then
            echo "$ticket_info"
        fi
    done
}
```

### 日付・曜日処理
```bash
# 日本語曜日取得
get_japanese_day_of_week() {
    local dow="$1"  # 1=月曜日, 7=日曜日
    
    case "$dow" in
        1) echo "月" ;;
        2) echo "火" ;;
        3) echo "水" ;;
        4) echo "木" ;;
        5) echo "金" ;;
        6) echo "土" ;;
        7) echo "日" ;;
    esac
}

# 月末日取得
get_last_day_of_month() {
    local year_month="$1"  # YYYY-MM
    date -d "${year_month}-01 + 1 month - 1 day" '+%Y-%m-%d'
}
```

### コマンドライン インターフェース
```bash
# 使用例
./ado-tracker.sh generate-work-table 2025-01 ./work_records/2025-01.md
./ado-tracker.sh generate-work-table 2025-02 ./work_records/2025-02.md --assignees "田中太郎,佐藤花子"
```

### 担当者フィルタ設定（.env）
`--assignees` を省略した場合は `.env` の `WORK_TABLE_ASSIGNEES` が使用される。
```bash
# .env
WORK_TABLE_ASSIGNEES="田中太郎,佐藤花子"
```

## Definition of Done
- 指定月のマークダウンテーブルが生成される
- 担当者が動的に検出・列生成される
- チケットステータス履歴が正しく反映される
- Blockedステータス時の表示制御が動作する
- 手入力用の空白列が適切に配置される
- 月間合計行が生成される
- 月単位の対応チケット番号・タイトルリストが出力される

## Dependencies
- US-001-INF-002 (データ管理)
- US-001-BE-002 (チケット一覧)
- US-001-BE-003 (履歴取得)

## Estimated Effort
3-4 hours

## Testing Strategy
- 複数担当者での月次テーブル生成テスト
- チケットステータス変更履歴の正確な反映テスト
- Blockedステータス制御のテスト
- 日付・曜日表示の正確性テスト
- マークダウン形式の妥当性テスト
- 月単位チケットリスト生成のテスト
- チケット番号・タイトル表示の正確性テスト
