# US-001-BE-005: エラーハンドリングとログ機能実装

## Task Overview
API呼び出し時のエラー処理、ログ出力、リトライ機能を実装し、システムの堅牢性を向上させる。

## Acceptance Criteria
- [x] HTTP エラー（4xx, 5xx）の適切な処理
- [x] ネットワークエラー時の自動リトライ
- [x] API レート制限（429エラー）の対応
- [x] 詳細なエラーメッセージの表示
- [x] 処理ログの出力（成功・失敗の記録）
- [x] 中断時の復旧機能
- [x] 設定可能なリトライ回数と間隔

## Technical Requirements
- HTTPステータスコードの判定
- 指数バックオフによるリトライ
- ログレベル（INFO, WARN, ERROR）の設定
- 標準エラー出力への適切な出力
- プロセス中断時の中間データ保存

## Implementation Details
```bash
# 実装対象関数
handle_api_error() {
    local http_code="$1"
    local response="$2"
    
    case "$http_code" in
        401) echo "認証エラー: PATを確認してください" ;;
        403) echo "権限エラー: プロジェクトへのアクセス権限がありません" ;;
        404) echo "リソースが見つかりません" ;;
        429) echo "レート制限: 待機後にリトライします" ;;
        5*) echo "サーバーエラー: しばらく待ってからリトライしてください" ;;
    esac
}

retry_with_backoff() {
    local command="$1"
    local max_retries="${2:-3}"
    local delay="${3:-1}"
    
    # 指数バックオフでリトライ
    # 成功まで最大max_retries回実行
}

log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] [$level] $message" >&2
}
```

## Error Scenarios
1. **認証エラー（401）**
   - PAT の有効性確認
   - 明確なエラーメッセージ表示

2. **権限エラー（403）**
   - プロジェクトアクセス権限の確認
   - 必要な権限の説明

3. **レート制限（429）**
   - Retry-After ヘッダーの解析
   - 適切な待機時間の設定

4. **ネットワークエラー**
   - 接続タイムアウト
   - DNS解決エラー

## Logging Strategy
```bash
# ログレベル設定
LOG_LEVEL="${LOG_LEVEL:-INFO}"

log_info() { [[ "$LOG_LEVEL" != "ERROR" ]] && log_message "INFO" "$1"; }
log_warn() { log_message "WARN" "$1"; }
log_error() { log_message "ERROR" "$1"; }

# 処理ログ例
log_info "チケット取得開始: プロジェクト=$PROJECT"
log_warn "API レート制限に到達: 60秒待機"
log_error "API接続失敗: HTTPコード=500"
```

## Recovery Mechanism
```bash
# 中断時の状態保存
save_checkpoint() {
    local checkpoint_file="data/checkpoint.json"
    local current_state="$1"
    
    echo "$current_state" > "$checkpoint_file"
    log_info "チェックポイント保存: $checkpoint_file"
}

# 復旧時の状態読み込み
load_checkpoint() {
    local checkpoint_file="data/checkpoint.json"
    
    if [[ -f "$checkpoint_file" ]]; then
        cat "$checkpoint_file"
        log_info "チェックポイントから復旧"
    fi
}
```

## Implementation Status
**✅ COMPLETED** - 2025-07-25

### 実装済み機能
- **handle_api_error()**: 各HTTPステータスコード（401, 403, 404, 429, 5xx, 000）に対する詳細なエラーハンドリングと対処法の提供
- **retry_with_backoff()**: 指数バックオフ機能付きリトライメカニズム（最大300秒まで）
- **save_checkpoint()/load_checkpoint()/clear_checkpoint()**: プロセス中断時の状態保存・復旧機能
- **log_message()**: タイムスタンプ付きログ機能（`[YYYY-MM-DD HH:MM:SS] [LEVEL] message`形式）
- **Enhanced call_ado_api()**: Retry-Afterヘッダー解析、指数バックオフ、詳細エラーハンドリング統合

### テスト実装
- **test_be005_error_handling.sh**: 包括的なエラーハンドリング機能テストスイート
- 各HTTPステータスコードのエラーハンドリング検証
- チェックポイント機能の保存・読み込み・削除テスト
- ログ機能とタイムスタンプ検証

### ドキュメント更新
- **README.md**: エラーハンドリングとログ機能の詳細説明を追加
- 使用例とトラブルシューティング情報を含む

## Definition of Done
- ✅ 全API呼び出しでエラーハンドリングが実装される
- ✅ レート制限時に適切に待機・リトライする
- ✅ エラー時に分かりやすいメッセージが表示される
- ✅ 処理ログが適切に出力される
- ✅ 中断時に安全に復旧できる

## Dependencies
- US-001-BE-001 (API接続)
- US-001-BE-002 (チケット一覧)
- US-001-BE-003 (履歴取得)
- US-001-BE-004 (詳細取得)

## Estimated Effort
2-3 hours

## Testing Strategy
- 無効なPATでの認証エラーテスト
- ネットワーク切断時の動作確認
- 大量リクエストでのレート制限テスト
- 処理中断・復旧のテスト