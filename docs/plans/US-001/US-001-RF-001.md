# US-001-RF-001: コードベース構造とテストファイル整理リファクタリング

## Task Overview
プロジェクトの成長に伴い、コードベースの構造を改善し、保守性とテスト性を向上させるためのリファクタリングを実施する。

## Acceptance Criteria
- [x] テストファイルをtestsディレクトリに整理
- [x] メインモジュール（ado-tracker.sh）の関数分割とモジュール化
- [x] 設定ファイルとドキュメントの構造改善
- [x] 重複コードの削除と共通関数の抽出
- [x] デバッグ用一時ファイルの自動クリーンアップ機能追加

## Current Issues

### 1. テストファイル散在
```
# 現在の状況
./test_*.sh (ルートディレクトリに散在)
├── test_basic_functionality.sh
├── test_be004_simple.sh  
├── test_be005_error_handling.sh
├── test_fe001_work_table.sh
├── test_workitem_details.sh
└── test_config_advanced.sh
```

### 2. メインモジュールの肥大化
- **ado-tracker.sh**: 1900行超の単一ファイル
- 機能別の責務分離が不十分
- テスタビリティの低下

### 3. 設定とドキュメントの分散
- 設定ファイルの管理方法が統一されていない
- ドキュメントの一部が実装と乖離

## Proposed Structure

### 1. テストディレクトリ構造
```
tests/
├── unit/                   # 単体テスト
│   ├── test_api.sh        # API機能テスト
│   ├── test_data.sh       # データ処理テスト  
│   ├── test_config.sh     # 設定管理テスト
│   └── test_output.sh     # 出力フォーマットテスト
├── integration/           # 結合テスト
│   ├── test_fetch_flow.sh # fetch機能フロー
│   ├── test_work_table.sh # 作業テーブル生成
│   └── test_error_scenarios.sh # エラーシナリオ
├── fixtures/              # テストデータ
│   ├── sample_workitems.json
│   ├── sample_status_history.json
│   └── expected_outputs/
└── helpers/               # テストヘルパー
    ├── test_utils.sh      # テスト共通関数
    ├── mock_api.sh        # API モック
    └── assertions.sh      # アサーション関数
```

### 2. モジュール分割構造
```
lib/
├── core/
│   ├── api_client.sh      # Azure DevOps API クライアント
│   ├── data_processor.sh  # データ処理・変換
│   ├── config_manager.sh  # 設定管理
│   └── logger.sh          # ログ機能
├── commands/
│   ├── fetch.sh          # fetchコマンド実装
│   ├── generate_table.sh # テーブル生成実装
│   └── test_connection.sh # 接続テスト実装
├── formatters/
│   ├── markdown.sh       # マークダウン出力
│   ├── json.sh          # JSON処理
│   └── table.sh         # テーブル整形
└── utils/
    ├── date_utils.sh     # 日付処理ユーティリティ
    ├── string_utils.sh   # 文字列処理ユーティリティ
    └── file_utils.sh     # ファイル処理ユーティリティ
```

### 3. プロジェクト全体構造
```
ado-history/
├── ado-tracker.sh         # メインエントリーポイント（軽量化）
├── lib/                   # モジュールライブラリ
├── tests/                 # テストスイート
├── config/                # 設定ファイル
│   ├── .env.template
│   └── defaults.conf
├── docs/                  # ドキュメント
├── scripts/               # 補助スクリプト
│   ├── setup.sh          # 環境セットアップ
│   ├── cleanup.sh        # クリーンアップ
│   └── install.sh        # インストール
└── work_records/          # 生成される作業記録
```

## Detailed Refactoring Plan

### Phase 1: テストファイル整理
```bash
# 1.1 テストディレクトリ構造作成
mkdir -p tests/{unit,integration,fixtures,helpers}

# 1.2 既存テストファイルの移動と分類
mv test_basic_functionality.sh tests/integration/
mv test_be004_simple.sh tests/unit/test_api.sh
mv test_be005_error_handling.sh tests/integration/test_error_scenarios.sh
mv test_fe001_work_table.sh tests/integration/test_work_table.sh
mv test_workitem_details.sh tests/unit/test_data.sh
mv test_config_advanced.sh tests/unit/test_config.sh

# 1.3 テストヘルパー関数の抽出
# 共通のテスト関数を tests/helpers/ に集約
```

### Phase 2: メインモジュール分割
```bash
# 2.1 コア機能の分離
extract_functions() {
  # API関連関数 → lib/core/api_client.sh
  - call_azure_devops_api()
  - handle_api_error()
  - retry_with_backoff()
  
  # データ処理関数 → lib/core/data_processor.sh  
  - extract_status_changes()
  - convert_to_jst()
  - extract_assignees_from_history()
  
  # 設定管理関数 → lib/core/config_manager.sh
  - load_config()
  - validate_config()
  - show_config()
}

# 2.2 コマンド実装の分離
extract_commands() {
  # fetch機能 → lib/commands/fetch.sh
  - cmd_fetch()
  - fetch_workitems()
  - fetch_all_status_history()
  
  # テーブル生成 → lib/commands/generate_table.sh
  - cmd_generate_work_table()
  - generate_monthly_work_table()
  - generate_table_header()
}
```

### Phase 3: ユーティリティ関数整理
```bash
# 3.1 日付処理の統一
lib/utils/date_utils.sh:
  - convert_to_jst()
  - get_japanese_day_of_week()
  - get_last_day_of_month()
  - validate_date_format()

# 3.2 文字列処理の統一  
lib/utils/string_utils.sh:
  - sanitize_filename()
  - truncate_string()
  - calculate_display_width()
  
# 3.3 ファイル処理の統一
lib/utils/file_utils.sh:
  - ensure_directory()
  - cleanup_temp_files()
  - backup_file()
```

## Future Improvements (範囲外)
このリファクタリング完了後に検討すべき追加改善項目：

- **エラーハンドリング統一**: `set -euo pipefail` + trap による統一処理
- **設定管理階層化**: システム→ユーザー→プロジェクト→環境変数の優先順位
- **ログ機能強化**: 構造化ログ、パフォーマンス計測、監査ログ
- **並列処理導入**: API呼び出しの並列化によるパフォーマンス向上
- **キャッシュ機能**: API応答のキャッシュによる高速化
- **デバッグ支援**: 一時ファイル自動クリーンアップ、デバッグモード

これらは別タスク（US-001-EN-xxx等）として後日実装を検討。

## Implementation Strategy

### 段階的実装アプローチ
1. **Phase 1** (1-2日): テストファイル整理
2. **Phase 2** (3-4日): コア機能のモジュール分割
3. **Phase 3** (2-3日): ユーティリティ関数整理
4. **Phase 4** (2-3日): 追加改善機能実装

### 後方互換性の維持
- メインエントリーポイント（ado-tracker.sh）のAPIは変更しない
- 既存の設定ファイル形式をサポート
- 段階的な移行パスを提供

## Testing Strategy

### 現在のテスト状況
- **メインモジュール**: 1,916行、約50関数
- **テストファイル**: 11個、合計2,974行
- **テスト/コード比**: 約1.55:1（行数ベース）

### テストカバレッジ目標
- **関数カバレッジ**: 60%以上（30/50関数）
- **主要コマンド**: 全コマンド（fetch, generate-work-table, test-connection等）
- **エラーハンドリング**: 主要エラーパターン
- **コマンドライン引数**: 主要パターン

### テスト戦略
- 各モジュールの単体テスト作成
- リファクタリング前後の動作比較テスト
- パフォーマンステスト（処理時間、メモリ使用量）
- 互換性テスト（既存設定での動作確認）

## Benefits
- **保守性向上**: 機能別モジュール分割による責務の明確化
- **テスタビリティ向上**: 単体テスト可能な粒度への分割
- **再利用性向上**: 共通機能の抽出と標準化
- **開発効率向上**: 構造化されたコードベースでの開発加速
- **品質向上**: 統一されたエラーハンドリングとログ機能

## Risks and Mitigation
- **リスク**: 大規模リファクタリングによる機能破壊
- **対策**: 段階的実装と包括的テストによる品質保証

- **リスク**: Shell scriptsの限界による複雑化
- **対策**: 必要に応じて他言語への移行パスを検討

## Definition of Done
- [ ] すべてのテストファイルがtests/配下に適切に分類されている
- [ ] メインモジュールが1000行以下に削減されている
- [ ] 各モジュールが単一責任の原則に従っている
- [ ] 全テストが新構造で正常に実行される
- [ ] リファクタリング前後で機能的な差異がない
- [ ] ドキュメントが新構造に対応して更新されている

## Dependencies
- 現在の実装が安定していること
- **十分なテストカバレッジがあること** (関数カバレッジ60%以上: 30/50関数)

## Estimated Effort
8-12 days (段階的実装)

## Priority
Medium - 機能開発が一段落した後の品質向上フェーズで実施