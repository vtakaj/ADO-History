# US-001-BE-003: チケットステータス変更履歴取得機能実装

## Task Overview
各チケットのステータス変更履歴を取得し、変更日時、変更前後のステータス、変更者情報を抽出する機能を実装する。

## Acceptance Criteria
- [x] 各チケットのUpdates履歴取得
- [x] ステータス変更のみをフィルタリング（初期作成除く）
- [x] 変更日時（日本時間）の正確な記録
- [x] 変更前ステータスと変更後ステータスの取得
- [x] 変更者（ユーザー）情報の取得
- [x] 担当者（assignedTo）情報の取得
- [x] 履歴データのJSON形式での保存
- [x] 履歴取得の進捗表示

## Technical Requirements
- Work Item Updates API の使用
- 日時のタイムゾーン変換（UTC → JST）
- ステータスフィールド変更の検出
- 担当者フィールド変更の検出
- バッチ処理（複数チケットの履歴取得）
- 進捗表示（処理中チケット数の表示）

## Implementation Details
```bash
# 実装済み関数
get_workitem_updates() {
    local workitem_id="$1"
    local project="$2"
    
    # Updates API呼び出し（ado-tracker.sh:719-745）
    # レスポンスの標準出力への出力
}

extract_status_changes() {
    local updates_json="$1"
    local workitem_id="$2"
    
    # ステータス変更の抽出（System.State フィールド）
    # 担当者情報の抽出（System.AssignedTo フィールド）
    # 初期作成（oldValue=null）を除外
    # 実際のステータス変更のみを対象
    # 担当者を各変更時点で計算
    # JST変換は後段で実行
}

fetch_all_status_history() {
    local project="$1"
    
    # 全Work Itemsの履歴取得
    # 進捗表示（処理済み/総件数）
    # JST変換とデータ保存
}
```

## API Endpoints
- GET `https://dev.azure.com/{organization}/{project}/_apis/wit/workitems/{id}/updates`
- Query parameters: `api-version=7.2`

## Filtering Specification
実装されたフィルタリング条件：
```jq
select(.previousStatus != null and .previousStatus != .newStatus)
```

**含まれるステータス変更：**
- ✅ `To do → Doing` （着手日として重要）
- ✅ `Doing → Done` （完了日として重要）
- ✅ `Doing → Blocked` （ブロック状況）
- ✅ `Code Review → Done` （レビュー完了）

**除外される変更：**
- ❌ `"" → To do` （初期作成）
- ❌ タイトル、説明、担当者などのメタデータ変更
- ❌ 同じステータスでの更新

## Data Structure
```json
{
  "status_history": [
    {
      "workitemId": 123,
      "changeDate": "2025-01-15T19:30:00+09:00",
      "changedBy": "ユーザー名",
      "assignedTo": "担当者名",
      "previousStatus": "To do",
      "newStatus": "Doing",
      "revision": 8
    }
  ]
}
```

## Time Zone Handling
```bash
# UTC to JST conversion
convert_to_jst() {
    local utc_time="$1"
    date -d "$utc_time +9 hours" '+%Y-%m-%dT%H:%M:%S+09:00'
}
```

## Definition of Done
- [x] 全チケットのステータス変更履歴が正確に取得される
- [x] 日時が日本時間で正しく記録される
- [x] 変更前後のステータスが正確に記録される
- [x] 各変更時点での担当者が正確に記録される
- [x] 履歴データがstatus_history.jsonに保存される
- [x] 初期作成を除外した実際のステータス変更のみが抽出される
- [x] テストケースで動作確認済み（74件のステータス変更を正常抽出）

## Dependencies
- US-001-BE-002 (チケット一覧)
- US-001-INF-002 (データ管理)

## Estimated Effort
3 hours

## Testing Strategy
- 複数回ステータス変更されたチケットでの確認
- 大量履歴データでの性能確認
- タイムゾーン変換の正確性確認
- ステータス以外の変更がフィルタリングされることの確認