# US-001-INF-002: データ保存用ディレクトリ構造とJSONファイル管理実装

## Task Overview
取得したデータを保存するためのディレクトリ構造作成とJSONファイル管理機能を実装する。

## Acceptance Criteria
- [x] データ保存用ディレクトリ（data/）の自動作成
- [x] JSONファイルの保存・読み込み機能
- [x] ファイル存在チェックとバックアップ機能
- [x] データ整合性チェック機能
- [x] ファイル権限の適切な設定
- [x] 古いデータのアーカイブ機能

## Technical Requirements
- mkdir -p によるディレクトリ作成
- jq コマンドによるJSON処理
- ファイル権限設定（600: 所有者のみ読み書き）
- JSONスキーマ検証
- ファイルロック機能（同時アクセス制御）

## Implementation Details
```bash
# データディレクトリ構造
DATA_DIR="./data"
BACKUP_DIR="./data/backup"

# ディレクトリ作成
init_data_directories() {
    mkdir -p "$DATA_DIR" "$BACKUP_DIR"
    chmod 700 "$DATA_DIR" "$BACKUP_DIR"
    
    log_info "データディレクトリを初期化: $DATA_DIR"
}

# JSONファイル保存
save_json() {
    local filename="$1"
    local data="$2"
    local filepath="$DATA_DIR/$filename"
    
    # バックアップ作成
    if [[ -f "$filepath" ]]; then
        cp "$filepath" "$BACKUP_DIR/${filename}.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # JSON形式検証
    if echo "$data" | jq empty 2>/dev/null; then
        echo "$data" | jq '.' > "$filepath"
        chmod 600 "$filepath"
        log_info "JSONファイル保存: $filepath"
    else
        log_error "無効なJSON形式: $filename"
        return 1
    fi
}

# JSONファイル読み込み
load_json() {
    local filename="$1"
    local filepath="$DATA_DIR/$filename"
    
    if [[ -f "$filepath" ]]; then
        if jq empty "$filepath" 2>/dev/null; then
            cat "$filepath"
        else
            log_error "破損したJSONファイル: $filepath"
            return 1
        fi
    else
        echo "{}"
    fi
}
```

## Directory Structure
```
./
├── ado-tracker.sh
└── data/
    ├── workitems.json          # チケット一覧
    ├── status_history.json     # ステータス履歴
    ├── workitem_details.json   # チケット詳細
    ├── checkpoint.json         # 処理状態
    └── backup/                 # バックアップファイル
        ├── workitems.json.20250115_143022
        └── status_history.json.20250115_143022
```

## File Management Functions
```bash
# ファイル存在チェック
file_exists() {
    local filename="$1"
    [[ -f "$DATA_DIR/$filename" ]]
}

# ファイルサイズチェック
check_file_size() {
    local filename="$1"
    local filepath="$DATA_DIR/$filename"
    
    if [[ -f "$filepath" ]]; then
        local size=$(stat -f%z "$filepath" 2>/dev/null || stat -c%s "$filepath" 2>/dev/null)
        echo "$size"
    else
        echo "0"
    fi
}

# データ整合性チェック
validate_json_schema() {
    local filename="$1"
    local expected_keys="$2"
    
    local filepath="$DATA_DIR/$filename"
    if [[ -f "$filepath" ]]; then
        local actual_keys=$(jq -r 'keys[]' "$filepath" 2>/dev/null | sort | tr '\n' ',')
        if [[ "$actual_keys" == "$expected_keys" ]]; then
            return 0
        else
            log_warn "JSONスキーマが期待値と異なります: $filename"
            return 1
        fi
    fi
}
```

## Archive Management
```bash
# 古いバックアップのクリーンアップ
cleanup_old_backups() {
    local days_to_keep="${1:-7}"
    
    find "$BACKUP_DIR" -name "*.json.*" -mtime +$days_to_keep -delete
    log_info "古いバックアップファイルをクリーンアップ: ${days_to_keep}日以前"
}

# データアーカイブ
archive_data() {
    local archive_name="archive_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    tar -czf "$BACKUP_DIR/$archive_name" -C "$DATA_DIR" \
        workitems.json status_history.json workitem_details.json
    
    log_info "データアーカイブ作成: $archive_name"
}
```

## Data Schema Definitions
```bash
# 期待されるデータスキーマ
WORKITEMS_SCHEMA="workitems"
STATUS_HISTORY_SCHEMA="status_history" 
WORKITEM_DETAILS_SCHEMA="workitem_details"

# スキーマ検証
validate_all_schemas() {
    validate_json_schema "workitems.json" "$WORKITEMS_SCHEMA," || return 1
    validate_json_schema "status_history.json" "$STATUS_HISTORY_SCHEMA," || return 1
    validate_json_schema "workitem_details.json" "$WORKITEM_DETAILS_SCHEMA," || return 1
    
    log_info "全データファイルのスキーマ検証完了"
}
```

## Implementation Status
✅ **完了** - 実装済み

### 実装内容
- `init_data_directories()`: データディレクトリ初期化
- `save_json()`: JSONファイル保存とバックアップ
- `load_json()`: JSONファイル読み込みと検証
- ファイル権限管理（600: 所有者のみ読み書き）
- 自動バックアップ機能（タイムスタンプ付き）

### データ管理機能
- workitems.json: Work Items基本情報
- status_history.json: ステータス変更履歴
- workitem_details.json: Work Item詳細情報（オプション）
- 自動バックアップとJSONスキーマ検証

## Definition of Done
- [x] data/ ディレクトリが自動作成される
- [x] JSONファイルが適切な権限で保存される
- [x] ファイル読み込み時にJSON形式が検証される
- [x] バックアップが自動作成される
- [x] データ整合性チェックが実装される

## Dependencies
- US-001-INF-001 (基本構造)

## Estimated Effort
2-3 hours

## Testing Strategy
- ディレクトリ作成権限のテスト
- 無効なJSONでの保存エラーテスト
- ファイル権限設定の確認
- バックアップ機能のテスト
- 大量データでの性能テスト